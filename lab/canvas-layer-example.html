<!DOCTYPE html>
<meta name="robots" content="noindex">
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>Canvas Layer example with Leaflet</title>
    <style>
      body {
        margin: 0;
        padding: 0;
      }
      #map {
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script src="https://maps.googleapis.com/maps/api/js"></script>
    <script src="https://code.jquery.com/jquery-2.1.4.js"></script>
    <script id="jsbin-javascript">
      var USERNAME = 'wri-01';
      var TABLENAME = 'gfw2_forma';

      /**
       * zoom + 8 is get because a tile in 'zoom' zoom level
       * is a pixel in 'zoom + 8' level.
       * Remember, it is a quadtree, 1^8 = 256 and tile size is 256px
       * @param  {Number} zoom
       * @return {Number}
       */
      function calcZoomDiff(zoom) {
        return zoom + 8 - Math.min(zoom + 8, 16);
      }

      /**
       * @param  {Object} data
       * @param  {Object} coord {x, y}
       * @param  {Number} zoom
       * @param  {Number} zoomDiff
       * @return {Object}
       */
      function cachedData(data, coord, zoom, zoomDiff) {
        var len = data.length;
        var xcoords, ycoords;

        if (typeof ArrayBuffer !== 'undefined') {
          xcoords = new Uint8Array(new ArrayBuffer(data.length));
          ycoords = new Uint8Array(new ArrayBuffer(data.length));
        } else {
          // IE fallback
          xcoords = ycoords = [];
        }

        var baseTileX = coord.x * 256;
        var baseTileY = coord.y * 256;

        for (var i = 0; i < len; i++) {
          var r = data[i];
          xcoords[i] = (r.x - baseTileX) << zoomDiff;
          ycoords[i] = (r.y - baseTileY) << zoomDiff;
        }

        return {
          length: len,
          xcoords: xcoords,
          ycoords: ycoords,
          size: 1 << zoomDiff
        };
      }

      /**
       * Called whenever the Google Maps API
       * determines that the map needs to display
       * new tiles for the given viewport.
       * @param  {Object}  canvas
       * @param  {Object}  coord         coordinates {x ,y}
       * @param  {Integer} zoom          current map zoom
       * @return {Canvas}  canvas        tile canvas
       */
      function createTile(canvas, data, coord, zoom) {
        var zoomDiff = calcZoomDiff(zoom);
        var cells = cachedData(data, coord, zoom, zoomDiff);

        if (!cells.length) {
          return;
        }

        for (var i = 0, len = cells.length - 1; i < len; i++) {
          canvas.ctx.fillStyle = 'rgb(233, 189, 21)';
          canvas.ctx.fillRect(cells.xcoords[i], cells.ycoords[i], cells.size, cells.size);
        }

        return canvas;
      }

      /**
       * Get tile data from CartoDB API SQL
       * @param  {Number} x
       * @param  {Number} y
       * @param  {Number} z
       * @return {Promise}
       */
      function getDataFromCartoDB(x, y, z) {
        var pixelZoom = Math.min(z + 8, 16);
        var zoomDiff = calcZoomDiff(z);

        var cx0 = (x * 256) >> zoomDiff;
        var cx1 = ((x + 1) * 256) >> zoomDiff;
        var cy0 = (y * 256) >> zoomDiff;
        var cy1 = ((y + 1) * 256) >> zoomDiff;
        var apiUrl = 'https://' + USERNAME + '.cartodb.com/api/v2/sql';
        var sql = 'SELECT cartodb_id, x, y FROM ' + TABLENAME + ' ';

        sql = sql + 'WHERE z = ' + pixelZoom + ' AND x >= ' + cx0 + ' AND ' +
        'x < ' + cx1 + ' AND y >= ' + cy0 + ' AND y < ' + cy1;

        // jQuery required only for ajax
        return $.get(apiUrl, {q: sql});
      }

      function GridMapType(tileSize) {
        this.tileSize = tileSize;
      }

      GridMapType.prototype.getTile = function(coord, zoom, ownerDocument) {
        var canvas = ownerDocument.createElement('canvas');
        var ctx = canvas.getContext('2d');
        ctx.width = canvas.width = this.tileSize.width;
        ctx.height = canvas.height = this.tileSize.height;
        canvas.ctx = ctx;

        getDataFromCartoDB(coord.x, coord.y, zoom).done(function(data) {
          createTile(canvas, data.rows, coord, zoom);
        });

        return canvas;
      };

      function onReady() {
        var map = new google.maps.Map(document.getElementById('map'), {
          zoom: 3,
          center: {lat: 0, lng: 0}
        });
        var canvasLayer = new GridMapType(new google.maps.Size(256, 256));

        // Adding layer
        map.overlayMapTypes.insertAt(0, canvasLayer);
      }

      document.addEventListener('DOMContentLoaded', onReady);
    </script>
  </body>
</html>
